<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WordBasket Online</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-css-reset@1.4.0/dist/reset.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    body { background: #f6f8ff; color: #1b1f3b; }
    .app-shell { max-width: 980px; margin: 0 auto; padding: 16px; }
    .glass-btn { background: rgba(32, 81, 229, 0.88); border: 0; color: #fff; }
    .panel { background: #fff; border-radius: 14px; padding: 12px; box-shadow: 0 3px 10px rgba(12,28,64,.08); }
    .char-card {
      min-width: 54px; min-height: 72px; border-radius: 12px;
      border: 2px solid #d7dcf4; background: #fff; display: inline-flex;
      justify-content: center; align-items: center; font-size: 28px; font-weight: 700;
      cursor: pointer; margin-right: 8px;
    }
    .char-card.selected { border-color: #2051e5; transform: translateY(-3px); }
    .char-card.field { width: 84px; height: 108px; font-size: 42px; margin: 0 auto; }
    .deck-card {
      width: 84px; height: 108px; border-radius: 12px; background: repeating-linear-gradient(45deg,#2543a9,#2543a9 10px,#365ddf 10px,#365ddf 20px);
      margin: 0 auto; position: relative;
    }
    .hand-scroll { overflow-x: auto; white-space: nowrap; padding-bottom: 6px; }
    .small-player { font-size: 0.9rem; }
    #toastBox { position: fixed; right: 12px; bottom: 12px; z-index: 9999; min-width: 220px; }
  </style>
</head>
<body>
<div class="app-shell">
  <h1 class="h3 mb-3"><i class="fa-solid fa-bolt"></i> ワードバスケット（オンライン早押し）</h1>

  <section id="lobbyView" class="panel">
    <div class="mb-3">
      <label class="form-label">プレイヤー名</label>
      <input id="nameInput" class="form-control" maxlength="16" placeholder="なまえ" value="Player" />
    </div>
    <div class="d-flex gap-2 mb-3">
      <button id="createRoomBtn" class="btn glass-btn"><i class="fa-solid fa-plus"></i> 新規ルーム作成</button>
      <button id="copyRoomBtn" class="btn btn-outline-primary d-none"><i class="fa-regular fa-copy"></i> ルームIDをコピー</button>
    </div>
    <div class="row g-2 align-items-end">
      <div class="col-sm-4">
        <label class="form-label">4桁ルームID</label>
        <input id="roomInput" class="form-control" maxlength="4" placeholder="0123" />
      </div>
      <div class="col-sm-3">
        <button id="joinRoomBtn" class="btn btn-primary w-100">参加</button>
      </div>
      <div class="col-sm-5">
        <div id="createdRoomText" class="text-primary fw-bold"></div>
      </div>
    </div>
  </section>

  <section id="gameView" class="d-none">
    <div class="panel mb-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <div class="small text-muted">ROOM</div>
          <div id="roomLabel" class="h5 mb-0"></div>
        </div>
        <div id="lastPlay" class="small text-muted">まだ成功プレイはありません</div>
        <div class="d-flex gap-2">
          <button id="undoBtn" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-rotate-left"></i> Undo</button>
          <button id="leaveBtn" class="btn btn-outline-danger btn-sm"><i class="fa-solid fa-right-from-bracket"></i> 退室</button>
        </div>
      </div>
      <div id="playersBox" class="mt-2"></div>
    </div>

    <div class="panel mb-3">
      <div class="row text-center align-items-center">
        <div class="col-6">
          <div class="small text-muted mb-1">山札</div>
          <div class="deck-card"><span id="deckCountBadge" class="badge text-bg-light position-absolute top-0 start-100 translate-middle"></span></div>
        </div>
        <div class="col-6">
          <div class="small text-muted mb-1">場の開始文字</div>
          <div id="fieldChar" class="char-card field">?</div>
        </div>
      </div>
    </div>

    <div class="panel mb-3">
      <div class="small text-muted mb-2">あなたの手札（タップして選択）</div>
      <div id="handBox" class="hand-scroll"></div>
    </div>

    <div class="panel">
      <div class="small mb-2">選択中の終端文字: <span id="selectedCharLabel" class="fw-bold">未選択</span></div>
      <div class="input-group">
        <input id="wordInput" class="form-control" placeholder="ことばを入力" />
        <button id="playBtn" class="btn btn-success">送信</button>
      </div>
    </div>
  </section>
</div>

<div id="toastBox"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script>
(() => {
  const state = {
    ws: null,
    roomId: null,
    myPlayerId: null,
    roomState: null,
    selectedEndChar: null,
    selectedDom: null
  };

  function toast(message, tone='danger') {
    const id = 't' + Date.now();
    $('#toastBox').append(`<div id="${id}" class="alert alert-${tone} py-2 px-3 mb-2">${message}</div>`);
    setTimeout(() => $('#' + id).fadeOut(300, () => $('#' + id).remove()), 1800);
  }

  function connect() {
    if (state.ws && state.ws.readyState <= 1) return;
    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    state.ws = new WebSocket(`${protocol}://${location.host}/ws`);

    state.ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      const { type, payload } = msg;
      if (type === 'room_created') {
        $('#createdRoomText').text(`作成済みROOM: ${payload.roomId}`);
        $('#roomInput').val(payload.roomId);
        $('#copyRoomBtn').removeClass('d-none').data('room', payload.roomId);
      } else if (type === 'join_ok') {
        state.myPlayerId = payload.playerId;
        state.roomState = payload.roomState;
        state.roomId = payload.roomState.roomId;
        location.hash = `#/room/${state.roomId}`;
        render();
      } else if (type === 'state_sync') {
        state.roomState = payload.roomState;
        render();
      } else if (type === 'play_result') {
        if (!payload.accepted) {
          animateReject();
          toast(`プレイ失敗: ${payload.reason}`);
          if (payload.roomState) state.roomState = payload.roomState;
        } else {
          toast('プレイ成功！', 'success');
          state.roomState = payload.roomState;
        }
        render();
      } else if (type === 'undo_result') {
        if (!payload.accepted) {
          toast(`Undo不可: ${payload.reason}`);
          if (payload.roomState) state.roomState = payload.roomState;
        } else {
          toast('Undo成功', 'success');
          state.roomState = payload.roomState;
        }
        render();
      } else if (type === 'room_full') {
        toast(`ROOM ${payload.roomId} は満室です`);
      } else if (type === 'error') {
        toast(payload.message || 'エラー');
      }
    };

    state.ws.onclose = () => toast('接続が切れました。再接続してください。', 'warning');
  }

  function send(type, payload) {
    connect();
    if (!state.ws || state.ws.readyState !== 1) return toast('接続待機中...');
    state.ws.send(JSON.stringify({ type, payload }));
  }

  function me() {
    return state.roomState?.players?.find(p => p.playerId === state.myPlayerId);
  }

  function animatePlayToField() {
    if (!state.selectedDom || !$('#fieldChar').length) return;
    const from = state.selectedDom.getBoundingClientRect();
    const to = $('#fieldChar')[0].getBoundingClientRect();
    const clone = $(state.selectedDom).clone().css({
      position: 'fixed', left: from.left, top: from.top, margin: 0, zIndex: 9998
    }).appendTo('body');
    gsap.to(clone[0], {
      x: to.left - from.left,
      y: to.top - from.top,
      scale: 0.8,
      duration: 0.35,
      ease: 'power2.out',
      onComplete: () => clone.remove()
    });
  }

  function animateReject() {
    if (!state.selectedDom) return;
    gsap.fromTo(state.selectedDom, { x: 0 }, { x: 10, duration: 0.05, repeat: 3, yoyo: true });
  }

  function renderPlayers() {
    if (!state.roomState) return;
    const html = state.roomState.players.map(p => {
      const icon = p.connected ? '<span class="text-success">●</span>' : '<span class="text-secondary">●</span>';
      const mine = p.playerId === state.myPlayerId ? ' (あなた)' : '';
      return `<span class="badge text-bg-light me-1 mb-1 small-player">${icon} ${p.name}${mine} / 手札:${p.handCount}</span>`;
    }).join('');
    $('#playersBox').html(html);
  }

  function renderHand() {
    const my = me();
    if (!my) return $('#handBox').html('');
    const html = (my.hand || []).map((c, idx) => `<button class="char-card" data-char="${c}" data-idx="${idx}">${c}</button>`).join('');
    $('#handBox').html(html || '<span class="text-success">手札0枚！</span>');

    $('#handBox .char-card').on('click', function () {
      $('#handBox .char-card').removeClass('selected');
      $(this).addClass('selected');
      state.selectedEndChar = $(this).data('char');
      state.selectedDom = this;
      $('#selectedCharLabel').text(state.selectedEndChar);
    });
  }

  function render() {
    const inRoom = !!state.roomState;
    $('#lobbyView').toggleClass('d-none', inRoom);
    $('#gameView').toggleClass('d-none', !inRoom);
    if (!inRoom) return;

    const rs = state.roomState;
    $('#roomLabel').text(rs.roomId);
    $('#fieldChar').text(rs.currentChar || '?');
    $('#deckCountBadge').text(rs.deckCount || 0);
    $('#lastPlay').text(rs.lastPlay ? `${rs.lastPlay.name}: 「${rs.lastPlay.word}」で成功` : 'まだ成功プレイはありません');
    if (rs.winner) {
      toast(`勝者: ${rs.winner.name} さん`, 'success');
    }
    renderPlayers();
    renderHand();
  }

  $('#createRoomBtn').on('click', () => {
    connect();
    send('create_room', { name: $('#nameInput').val() });
  });

  $('#copyRoomBtn').on('click', function () {
    const room = $(this).data('room');
    navigator.clipboard.writeText(room).then(() => toast('コピーしました', 'success')).catch(() => toast('コピー失敗'));
  });

  $('#joinRoomBtn').on('click', () => {
    const roomId = String($('#roomInput').val() || '').replace(/\D/g, '').padStart(4, '0').slice(-4);
    const name = $('#nameInput').val();
    if (!/^\d{4}$/.test(roomId)) return toast('4桁数字で入力してください');
    connect();
    send('join_room', { roomId, name });
  });

  $('#playBtn').on('click', () => {
    if (!state.roomState) return;
    const word = $('#wordInput').val().trim();
    if (!state.selectedEndChar) return toast('手札を選択してください');
    if (!word) return toast('単語を入力してください');
    animatePlayToField();
    send('play_request', {
      roomId: state.roomState.roomId,
      playerId: state.myPlayerId,
      endChar: state.selectedEndChar,
      word
    });
  });

  $('#wordInput').on('keypress', (ev) => {
    if (ev.key === 'Enter') $('#playBtn').trigger('click');
  });

  $('#undoBtn').on('click', () => {
    const actionId = state.roomState?.lastAction?.actionId;
    if (!actionId) return toast('Undoできる直近手がありません');
    send('undo_request', { roomId: state.roomId, playerId: state.myPlayerId, actionId });
  });

  $('#leaveBtn').on('click', () => {
    if (state.roomId && state.myPlayerId) send('leave_room', { roomId: state.roomId, playerId: state.myPlayerId });
    state.roomId = null;
    state.myPlayerId = null;
    state.roomState = null;
    state.selectedEndChar = null;
    state.selectedDom = null;
    location.hash = '#/';
    render();
  });

  connect();
  render();
})();
</script>
</body>
</html>
